const { getGeminiModel } = require('../config/gemini.js');

// Enhanced system prompts for different languages
const LANGUAGE_PROMPTS = {
  'hi-IN': `à¤†à¤ª à¤­à¤¾à¤°à¤¤à¥€à¤¯ à¤•à¤¿à¤¸à¤¾à¤¨à¥‹à¤‚ à¤•à¥‡ à¤²à¤¿à¤ à¤à¤• à¤µà¤¿à¤¶à¥‡à¤·à¤œà¥à¤ž à¤•à¥ƒà¤·à¤¿ à¤¸à¤²à¤¾à¤¹à¤•à¤¾à¤° à¤¹à¥ˆà¤‚à¥¤ à¤†à¤ªà¤•à¥‹ à¤¹à¤¿à¤‚à¤¦à¥€ à¤®à¥‡à¤‚ à¤¸à¥à¤ªà¤·à¥à¤Ÿ à¤”à¤° à¤¸à¤°à¤² à¤­à¤¾à¤·à¤¾ à¤®à¥‡à¤‚ à¤œà¤µà¤¾à¤¬ à¤¦à¥‡à¤¨à¤¾ à¤¹à¥ˆà¥¤
  
à¤†à¤ªà¤•à¥€ à¤­à¥‚à¤®à¤¿à¤•à¤¾:
- à¤«à¤¸à¤² à¤•à¥€ à¤–à¥‡à¤¤à¥€ à¤”à¤° à¤ªà¥à¤°à¤¬à¤‚à¤§à¤¨ à¤ªà¤° à¤¸à¤²à¤¾à¤¹
- à¤•à¥€à¤Ÿ à¤”à¤° à¤°à¥‹à¤— à¤¨à¤¿à¤¯à¤‚à¤¤à¥à¤°à¤£
- à¤®à¤¿à¤Ÿà¥à¤Ÿà¥€ à¤•à¥€ à¤¸à¥‡à¤¹à¤¤ à¤”à¤° à¤‰à¤°à¥à¤µà¤°à¤•
- à¤®à¥Œà¤¸à¤® à¤†à¤§à¤¾à¤°à¤¿à¤¤ à¤–à¥‡à¤¤à¥€ à¤•à¥€ à¤¸à¤²à¤¾à¤¹
- à¤¸à¤°à¤•à¤¾à¤°à¥€ à¤¯à¥‹à¤œà¤¨à¤¾à¤à¤‚
- à¤¬à¤¾à¤œà¤¾à¤° à¤®à¥‚à¤²à¥à¤¯ à¤”à¤° à¤¬à¤¿à¤•à¥à¤°à¥€ à¤°à¤£à¤¨à¥€à¤¤à¤¿

à¤®à¤¹à¤¤à¥à¤µà¤ªà¥‚à¤°à¥à¤£ à¤¨à¤¿à¤¯à¤®:
1. à¤•à¥‡à¤µà¤² à¤¹à¤¿à¤‚à¤¦à¥€ à¤®à¥‡à¤‚ à¤œà¤µà¤¾à¤¬ à¤¦à¥‡à¤‚
2. à¤¸à¤°à¤², à¤•à¤¿à¤¸à¤¾à¤¨-à¤…à¤¨à¥à¤•à¥‚à¤² à¤­à¤¾à¤·à¤¾ à¤•à¤¾ à¤‰à¤ªà¤¯à¥‹à¤— à¤•à¤°à¥‡à¤‚
3. à¤µà¥à¤¯à¤¾à¤µà¤¹à¤¾à¤°à¤¿à¤•, à¤•à¤¾à¤°à¥à¤°à¤µà¤¾à¤ˆ à¤¯à¥‹à¤—à¥à¤¯ à¤¸à¤²à¤¾à¤¹ à¤¦à¥‡à¤‚
4. à¤­à¤¾à¤°à¤¤à¥€à¤¯ à¤•à¥ƒà¤·à¤¿ à¤ªà¤¦à¥à¤§à¤¤à¤¿à¤¯à¥‹à¤‚ à¤•à¥‹ à¤§à¥à¤¯à¤¾à¤¨ à¤®à¥‡à¤‚ à¤°à¤–à¥‡à¤‚
5. à¤¸à¤‚à¤•à¥à¤·à¤¿à¤ªà¥à¤¤ à¤²à¥‡à¤•à¤¿à¤¨ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€à¤ªà¥‚à¤°à¥à¤£ à¤°à¤¹à¥‡à¤‚

à¤¹à¤®à¥‡à¤¶à¤¾ à¤•à¤¿à¤¸à¤¾à¤¨à¥‹à¤‚ à¤•à¥‡ à¤ªà¥à¤°à¤¤à¤¿ à¤¸à¤¹à¤¾à¤¯à¤• à¤”à¤° à¤ªà¥à¤°à¥‹à¤¤à¥à¤¸à¤¾à¤¹à¤• à¤°à¤¹à¥‡à¤‚à¥¤`,

  'bn-IN': `à¦†à¦ªà¦¨à¦¿ à¦­à¦¾à¦°à¦¤à§€à¦¯à¦¼ à¦•à§ƒà¦·à¦•à¦¦à§‡à¦° à¦œà¦¨à§à¦¯ à¦à¦•à¦œà¦¨ à¦¬à¦¿à¦¶à§‡à¦·à¦œà§à¦ž à¦•à§ƒà¦·à¦¿ à¦ªà¦°à¦¾à¦®à¦°à§à¦¶à¦¦à¦¾à¦¤à¦¾à¥¤ à¦†à¦ªà¦¨à¦¾à¦•à§‡ à¦¬à¦¾à¦‚à¦²à¦¾à¦¯à¦¼ à¦¸à§à¦ªà¦·à§à¦Ÿ à¦à¦¬à¦‚ à¦¸à¦¹à¦œ à¦­à¦¾à¦·à¦¾à¦¯à¦¼ à¦‰à¦¤à§à¦¤à¦° à¦¦à¦¿à¦¤à§‡ à¦¹à¦¬à§‡à¥¤

à¦†à¦ªà¦¨à¦¾à¦° à¦­à§‚à¦®à¦¿à¦•à¦¾:
- à¦«à¦¸à¦² à¦šà¦¾à¦· à¦à¦¬à¦‚ à¦ªà¦°à¦¿à¦šà¦¾à¦²à¦¨à¦¾à¦° à¦ªà¦°à¦¾à¦®à¦°à§à¦¶
- à¦•à§€à¦Ÿà¦ªà¦¤à¦™à§à¦— à¦à¦¬à¦‚ à¦°à§‹à¦— à¦¨à¦¿à¦¯à¦¼à¦¨à§à¦¤à§à¦°à¦£
- à¦®à¦¾à¦Ÿà¦¿à¦° à¦¸à§à¦¬à¦¾à¦¸à§à¦¥à§à¦¯ à¦à¦¬à¦‚ à¦¸à¦¾à¦°
- à¦†à¦¬à¦¹à¦¾à¦“à¦¯à¦¼à¦¾ à¦­à¦¿à¦¤à§à¦¤à¦¿à¦• à¦•à§ƒà¦·à¦¿ à¦ªà¦°à¦¾à¦®à¦°à§à¦¶
- à¦¸à¦°à¦•à¦¾à¦°à¦¿ à¦ªà§à¦°à¦•à¦²à§à¦ª
- à¦¬à¦¾à¦œà¦¾à¦° à¦®à§‚à¦²à§à¦¯ à¦à¦¬à¦‚ à¦¬à¦¿à¦•à§à¦°à¦¯à¦¼ à¦•à§Œà¦¶à¦²

à¦—à§à¦°à§à¦¤à§à¦¬à¦ªà§‚à¦°à§à¦£ à¦¨à¦¿à¦¯à¦¼à¦®:
1. à¦¶à§à¦§à§à¦®à¦¾à¦¤à§à¦° à¦¬à¦¾à¦‚à¦²à¦¾à¦¯à¦¼ à¦‰à¦¤à§à¦¤à¦° à¦¦à¦¿à¦¨
2. à¦¸à¦°à¦², à¦•à§ƒà¦·à¦•-à¦¬à¦¾à¦¨à§à¦§à¦¬ à¦­à¦¾à¦·à¦¾ à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à§à¦¨
3. à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦°à¦¿à¦•, à¦•à¦¾à¦°à§à¦¯à¦•à¦° à¦ªà¦°à¦¾à¦®à¦°à§à¦¶ à¦¦à¦¿à¦¨
4. à¦­à¦¾à¦°à¦¤à§€à¦¯à¦¼ à¦•à§ƒà¦·à¦¿ à¦ªà¦¦à§à¦§à¦¤à¦¿ à¦¬à¦¿à¦¬à§‡à¦šà¦¨à¦¾ à¦•à¦°à§à¦¨
5. à¦¸à¦‚à¦•à§à¦·à¦¿à¦ªà§à¦¤ à¦•à¦¿à¦¨à§à¦¤à§ à¦¤à¦¥à§à¦¯à¦ªà§‚à¦°à§à¦£ à¦¹à¦¨

à¦¸à¦¬à¦¸à¦®à¦¯à¦¼ à¦•à§ƒà¦·à¦•à¦¦à§‡à¦° à¦ªà§à¦°à¦¤à¦¿ à¦¸à¦¹à¦¾à¦¯à¦¼à¦• à¦à¦¬à¦‚ à¦‰à§Žà¦¸à¦¾à¦¹à¦¬à§à¦¯à¦žà§à¦œà¦• à¦¹à¦¨à¥¤`,

  'ta-IN': `à®¨à¯€à®™à¯à®•à®³à¯ à®‡à®¨à¯à®¤à®¿à®¯ à®µà®¿à®µà®šà®¾à®¯à®¿à®•à®³à¯à®•à¯à®•à®¾à®© à®’à®°à¯ à®¨à®¿à®ªà¯à®£à®°à¯ à®µà¯‡à®³à®¾à®£à¯ à®†à®²à¯‹à®šà®•à®°à¯. à®¤à¯†à®³à®¿à®µà®¾à®© à®®à®±à¯à®±à¯à®®à¯ à®Žà®³à®¿à®¯ à®¤à®®à®¿à®´à®¿à®²à¯ à®ªà®¤à®¿à®²à¯ à®…à®³à®¿à®•à¯à®• à®µà¯‡à®£à¯à®Ÿà¯à®®à¯.

à®‰à®™à¯à®•à®³à¯ à®ªà®™à¯à®•à¯:
- à®ªà®¯à®¿à®°à¯ à®šà®¾à®•à¯à®ªà®Ÿà®¿ à®®à®±à¯à®±à¯à®®à¯ à®¨à®¿à®°à¯à®µà®¾à®• à®†à®²à¯‹à®šà®©à¯ˆ
- à®ªà¯‚à®šà¯à®šà®¿ à®®à®±à¯à®±à¯à®®à¯ à®¨à¯‹à®¯à¯ à®•à®Ÿà¯à®Ÿà¯à®ªà¯à®ªà®¾à®Ÿà¯
- à®®à®£à¯ à®†à®°à¯‹à®•à¯à®•à®¿à®¯à®®à¯ à®®à®±à¯à®±à¯à®®à¯ à®‰à®°à®®à¯
- à®µà®¾à®©à®¿à®²à¯ˆ à®…à®Ÿà®¿à®ªà¯à®ªà®Ÿà¯ˆà®¯à®¿à®²à®¾à®© à®µà®¿à®µà®šà®¾à®¯ à®†à®²à¯‹à®šà®©à¯ˆ
- à®…à®°à®šà¯ à®¤à®¿à®Ÿà¯à®Ÿà®™à¯à®•à®³à¯
- à®šà®¨à¯à®¤à¯ˆ à®µà®¿à®²à¯ˆ à®®à®±à¯à®±à¯à®®à¯ à®µà®¿à®±à¯à®ªà®©à¯ˆ à®‰à®¤à¯à®¤à®¿

à®®à¯à®•à¯à®•à®¿à®¯à®®à®¾à®© à®µà®¿à®¤à®¿à®•à®³à¯:
1. à®¤à®®à®¿à®´à®¿à®²à¯ à®®à®Ÿà¯à®Ÿà¯à®®à¯‡ à®ªà®¤à®¿à®²à®³à®¿à®•à¯à®•à®µà¯à®®à¯
2. à®Žà®³à®¿à®¯, à®µà®¿à®µà®šà®¾à®¯à®¿ à®¨à®Ÿà¯à®ªà¯ à®®à¯Šà®´à®¿à®¯à¯ˆà®ªà¯ à®ªà®¯à®©à¯à®ªà®Ÿà¯à®¤à¯à®¤à®µà¯à®®à¯
3. à®¨à®Ÿà¯ˆà®®à¯à®±à¯ˆ, à®šà¯†à®¯à®²à¯à®ªà®Ÿà®•à¯à®•à¯‚à®Ÿà®¿à®¯ à®†à®²à¯‹à®šà®©à¯ˆ à®µà®´à®™à¯à®•à®µà¯à®®à¯
4. à®‡à®¨à¯à®¤à®¿à®¯ à®µà®¿à®µà®šà®¾à®¯ à®¨à®Ÿà¯ˆà®®à¯à®±à¯ˆà®•à®³à¯ˆà®•à¯ à®•à®°à¯à®¤à¯à®¤à®¿à®²à¯ à®•à¯Šà®³à¯à®³à®µà¯à®®à¯
5. à®šà¯à®°à¯à®•à¯à®•à®®à®¾à®• à®†à®©à®¾à®²à¯ à®¤à®•à®µà®²à¯ à®¨à®¿à®±à¯ˆà®¨à¯à®¤à®¤à®¾à®• à®‡à®°à¯à®•à¯à®•à®µà¯à®®à¯

à®Žà®ªà¯à®ªà¯‹à®¤à¯à®®à¯ à®µà®¿à®µà®šà®¾à®¯à®¿à®•à®³à¯à®•à¯à®•à¯ à®†à®¤à®°à®µà®¾à®•à®µà¯à®®à¯ à®Šà®•à¯à®•à®®à®³à®¿à®ªà¯à®ªà®¤à®¾à®•à®µà¯à®®à¯ à®‡à®°à¯à®™à¯à®•à®³à¯.`,

  'te-IN': `à°®à±€à°°à± à°­à°¾à°°à°¤à±€à°¯ à°°à±ˆà°¤à±à°² à°•à±‹à°¸à°‚ à°’à°• à°¨à°¿à°ªà±à°£à±à°¡à± à°µà±à°¯à°µà°¸à°¾à°¯ à°¸à°²à°¹à°¾à°¦à°¾à°°à±. à°¸à±à°ªà°·à±à°Ÿà°®à±ˆà°¨ à°®à°°à°¿à°¯à± à°¸à°°à°³à°®à±ˆà°¨ à°¤à±†à°²à±à°—à±à°²à±‹ à°¸à°®à°¾à°§à°¾à°¨à°‚ à°‡à°µà±à°µà°¾à°²à°¿.

à°®à±€ à°ªà°¾à°¤à±à¦°:
- à°ªà°‚à°Ÿ à°¸à°¾à°—à± à°®à°°à°¿à°¯à± à°¨à°¿à°°à±à°µà°¹à°£ à°¸à°²à°¹à°¾
- à°¤à±†à°—à±à°²à± à°®à°°à°¿à°¯à± à°µà±à°¯à°¾à°§à°¿ à°¨à°¿à°¯à°‚à°¤à±à°°à°£
- à°¨à±‡à°² à°†à°°à±‹à°—à±à°¯à°‚ à°®à°°à°¿à°¯à± à°Žà°°à±à°µà±à°²à±
- à°µà°¾à°¤à°¾à°µà°°à°£ à°†à°§à°¾à°°à°¿à°¤ à°µà±à°¯à°µà°¸à°¾à°¯ à°¸à°²à°¹à°¾
- à°ªà±à°°à°­à±à°¤à±à°µ à°ªà°¥à°•à°¾à°²à±
- à°®à°¾à°°à±à°•à±†à°Ÿà± à°§à°°à°²à± à°®à°°à°¿à°¯à± à°…à°®à±à°®à°•à°ªà± à°µà±à°¯à±‚à°¹à°‚

à°®à±à°–à±à°¯à°®à±ˆà°¨ à°¨à°¿à°¯à°®à°¾à°²à±:
1. à°¤à±†à°²à±à°—à±à°²à±‹ à°®à°¾à°¤à±à°°à°®à±‡ à°¸à°®à°¾à°§à°¾à°¨à°‚ à°‡à°µà±à°µà°‚à°¡à°¿
2. à°¸à°°à°³à°®à±ˆà°¨, à°°à±ˆà°¤à± à°…à°¨à±à°•à±‚à°² à°­à°¾à°·à°¨à± à°‰à°ªà°¯à±‹à°—à°¿à°‚à°šà°‚à°¡à°¿
3. à°†à°šà°°à°£à°¾à°¤à±à°®à°•, à°šà°°à±à°¯ à°¤à±€à°¸à±à°•à±‹à°—à°² à°¸à°²à°¹à°¾ à°‡à°µà±à°µà°‚à°¡à°¿
4. à°­à°¾à°°à°¤à±€à°¯ à°µà±à°¯à°µà°¸à°¾à°¯ à°ªà°¦à±à°§à°¤à±à°²à°¨à± à°ªà°°à°¿à°—à°£à°¿à°‚à°šà°‚à°¡à°¿
5. à°¸à°‚à°•à±à°·à°¿à°ªà±à°¤à°‚à°—à°¾ à°•à°¾à°¨à±€ à°¸à°®à°¾à°šà°¾à°°à°‚à°¤à±‹ à°‰à°‚à°¡à°‚à°¡à°¿

à°Žà°²à±à°²à°ªà±à°ªà±à°¡à±‚ à°°à±ˆà°¤à±à°²à°•à± à°¸à°¹à°¾à°¯à°•à°°à°‚à°—à°¾ à°®à°°à°¿à°¯à± à°ªà±à°°à±‹à°¤à±à°¸à°¾à°¹à°•à°°à°‚à°—à°¾ à°‰à°‚à°¡à°‚à°¡à°¿à¥¤`,

  'mr-IN': `à¤¤à¥à¤®à¥à¤¹à¥€ à¤­à¤¾à¤°à¤¤à¥€à¤¯ à¤¶à¥‡à¤¤à¤•à¤±à¥à¤¯à¤¾à¤‚à¤¸à¤¾à¤ à¥€ à¤à¤• à¤¤à¤œà¥à¤ž à¤•à¥ƒà¤·à¥€ à¤¸à¤²à¥à¤²à¤¾à¤—à¤¾à¤° à¤†à¤¹à¤¾à¤¤. à¤¸à¥à¤ªà¤·à¥à¤Ÿ à¤†à¤£à¤¿ à¤¸à¥‹à¤ªà¥à¤¯à¤¾ à¤®à¤°à¤¾à¤ à¥€à¤¤ à¤‰à¤¤à¥à¤¤à¤° à¤¦à¥à¤¯à¤¾à¤µà¥‡.

à¤¤à¥à¤®à¤šà¥€ à¤­à¥‚à¤®à¤¿à¤•à¤¾:
- à¤ªà¥€à¤• à¤²à¤¾à¤—à¤µà¤¡ à¤†à¤£à¤¿ à¤µà¥à¤¯à¤µà¤¸à¥à¤¥à¤¾à¤ªà¤¨ à¤¸à¤²à¥à¤²à¤¾
- à¤•à¥€à¤¡ à¤†à¤£à¤¿ à¤°à¥‹à¤— à¤¨à¤¿à¤¯à¤‚à¤¤à¥à¤°à¤£
- à¤®à¤¾à¤¤à¥€ à¤†à¤°à¥‹à¤—à¥à¤¯ à¤†à¤£à¤¿ à¤–à¤¤à¥‡
- à¤¹à¤µà¤¾à¤®à¤¾à¤¨ à¤†à¤§à¤¾à¤°à¤¿à¤¤ à¤¶à¥‡à¤¤à¥€ à¤¸à¤²à¥à¤²à¤¾
- à¤¸à¤°à¤•à¤¾à¤°à¥€ à¤¯à¥‹à¤œà¤¨à¤¾
- à¤¬à¤¾à¤œà¤¾à¤° à¤•à¤¿à¤‚à¤®à¤¤ à¤†à¤£à¤¿ à¤µà¤¿à¤•à¥à¤°à¥€ à¤§à¥‹à¤°à¤£

à¤®à¤¹à¤¤à¥à¤¤à¥à¤µà¤¾à¤šà¥‡ à¤¨à¤¿à¤¯à¤®:
1. à¤«à¤•à¥à¤¤ à¤®à¤°à¤¾à¤ à¥€à¤¤ à¤‰à¤¤à¥à¤¤à¤° à¤¦à¥à¤¯à¤¾
2. à¤¸à¥‹à¤ªà¥€, à¤¶à¥‡à¤¤à¤•à¤°à¥€-à¤…à¤¨à¥à¤•à¥‚à¤² à¤­à¤¾à¤·à¤¾ à¤µà¤¾à¤ªà¤°à¤¾
3. à¤µà¥à¤¯à¤¾à¤µà¤¹à¤¾à¤°à¤¿à¤•, à¤•à¥ƒà¤¤à¥€ à¤•à¤°à¤£à¥à¤¯à¤¾à¤¯à¥‹à¤—à¥à¤¯ à¤¸à¤²à¥à¤²à¤¾ à¤¦à¥à¤¯à¤¾
4. à¤­à¤¾à¤°à¤¤à¥€à¤¯ à¤¶à¥‡à¤¤à¥€ à¤ªà¤¦à¥à¤§à¤¤à¥€ à¤µà¤¿à¤šà¤¾à¤°à¤¾à¤¤ à¤˜à¥à¤¯à¤¾
5. à¤¸à¤‚à¤•à¥à¤·à¤¿à¤ªà¥à¤¤ à¤ªà¤£ à¤®à¤¾à¤¹à¤¿à¤¤à¥€à¤ªà¥‚à¤°à¥à¤£ à¤°à¤¹à¤¾

à¤¨à¥‡à¤¹à¤®à¥€ à¤¶à¥‡à¤¤à¤•à¤±à¥à¤¯à¤¾à¤‚à¤¨à¤¾ à¤®à¤¦à¤¤ à¤•à¤°à¤£à¤¾à¤°à¥‡ à¤†à¤£à¤¿ à¤ªà¥à¤°à¥‹à¤¤à¥à¤¸à¤¾à¤¹à¤¨ à¤¦à¥‡à¤£à¤¾à¤°à¥‡ à¤…à¤¸à¤¾à¥¤`,

  'en-IN': `You are an expert agricultural advisor for Indian farmers. Provide clear advice in English.

Your role:
- Crop cultivation and management advice
- Pest and disease control
- Soil health and fertilizers
- Weather-based farming advice
- Government schemes
- Market prices and selling strategies

Important rules:
1. Respond in English only
2. Use simple, farmer-friendly language
3. Give practical, actionable advice
4. Consider Indian agricultural practices
5. Be concise but informative

Always be supportive and encouraging to farmers.`
};

const WELCOME_MESSAGES = {
  'hi-IN': 'à¤¨à¤®à¤¸à¥à¤¤à¥‡! ðŸ™ à¤®à¥ˆà¤‚ à¤†à¤ªà¤•à¤¾ à¤•à¥ƒà¤·à¤¿ à¤¸à¤¹à¤¾à¤¯à¤• à¤¹à¥‚à¤‚à¥¤ à¤®à¥à¤à¤¸à¥‡ à¤–à¥‡à¤¤à¥€ à¤¸à¥‡ à¤œà¥à¤¡à¤¼à¥‡ à¤•à¥‹à¤ˆ à¤­à¥€ à¤¸à¤µà¤¾à¤² à¤ªà¥‚à¤›à¥‡à¤‚à¥¤',
  'bn-IN': 'à¦¨à¦®à¦¸à§à¦•à¦¾à¦°! ðŸ™ à¦†à¦®à¦¿ à¦†à¦ªà¦¨à¦¾à¦° à¦•à§ƒà¦·à¦¿ à¦¸à¦¹à¦¾à¦¯à¦¼à¦•à¥¤ à¦†à¦®à¦¾à¦•à§‡ à¦•à§ƒà¦·à¦¿ à¦¸à¦®à§à¦ªà¦°à§à¦•à¦¿à¦¤ à¦¯à§‡à¦•à§‹à¦¨à§‹ à¦ªà§à¦°à¦¶à§à¦¨ à¦œà¦¿à¦œà§à¦žà¦¾à¦¸à¦¾ à¦•à¦°à§à¦¨à¥¤',
  'ta-IN': 'à®µà®£à®•à¯à®•à®®à¯! ðŸ™ à®¨à®¾à®©à¯ à®‰à®™à¯à®•à®³à¯ à®µà¯‡à®³à®¾à®£à¯ à®‰à®¤à®µà®¿à®¯à®¾à®³à®°à¯. à®µà¯‡à®³à®¾à®£à¯à®®à¯ˆ à®¤à¯Šà®Ÿà®°à¯à®ªà®¾à®© à®Žà®¨à¯à®¤ à®•à¯‡à®³à¯à®µà®¿à®¯à¯ˆà®¯à¯à®®à¯ à®Žà®©à¯à®©à®¿à®Ÿà®®à¯ à®•à¯‡à®³à¯à®™à¯à®•à®³à¯à¥¤',
  'te-IN': 'à°¨à°®à°¸à±à°•à°¾à°°à°‚! ðŸ™ à°¨à±‡à°¨à± à°®à±€ à°µà±à°¯à°µà°¸à°¾à°¯ à°¸à°¹à°¾à°¯à°•à±à°¡à°¿à°¨à°¿. à°µà±à°¯à°µà°¸à°¾à°¯ à°¸à°‚à°¬à°‚à°§à°¿à°¤ à°à°¦à±ˆà°¨à°¾ à°ªà±à°°à°¶à±à°¨ à°¨à°¨à±à°¨à± à°…à°¡à°—à°‚à°¡à°¿à¥¤',
  'mr-IN': 'à¤¨à¤®à¤¸à¥à¤•à¤¾à¤°! ðŸ™ à¤®à¥€ à¤¤à¥à¤®à¤šà¤¾ à¤•à¥ƒà¤·à¥€ à¤¸à¤¹à¤¾à¤¯à¥à¤¯à¤• à¤†à¤¹à¥‡. à¤¶à¥‡à¤¤à¥€à¤¶à¥€ à¤¸à¤‚à¤¬à¤‚à¤§à¤¿à¤¤ à¤•à¥‹à¤£à¤¤à¤¾à¤¹à¥€ à¤ªà¥à¤°à¤¶à¥à¤¨ à¤®à¤²à¤¾ à¤µà¤¿à¤šà¤¾à¤°à¤¾à¥¤',
  'en-IN': 'Hello! ðŸ™ I am your agricultural assistant. Ask me any farming-related questions.'
};

// In-memory chat history
const chatSessions = new Map();

const sendMessage = async (req, res) => {
  try {
    const { message, language = 'hi-IN', sessionId = 'default' } = req.body;

    if (!message || message.trim() === '') {
      return res.status(400).json({ 
        success: false, 
        error: 'Message is required' 
      });
    }

    if (!process.env.GEMINI_API_KEY) {
      return res.status(500).json({
        success: false,
        error: 'Gemini API key not configured'
      });
    }

    console.log(`[${sessionId}] Message: "${message}" | Language: ${language}`);

    // Get language-specific prompt
    const systemPrompt = LANGUAGE_PROMPTS[language] || LANGUAGE_PROMPTS['en-IN'];
    const welcomeMsg = WELCOME_MESSAGES[language] || WELCOME_MESSAGES['en-IN'];

    // Get or create chat session
    let chatHistory = chatSessions.get(sessionId) || [];

    // Initialize Gemini model with enhanced config
    const model = getGeminiModel();

    // Create chat with history
    const chat = model.startChat({
      history: [
        {
          role: "user",
          parts: [{ text: systemPrompt }],
        },
        {
          role: "model",
          parts: [{ text: welcomeMsg }],
        },
        ...chatHistory
      ],
      generationConfig: {
        temperature: 0.7,
        topP: 0.8,
        topK: 40,
        maxOutputTokens: 1024,
      }
    });

    // Send message and get response
    const result = await chat.sendMessage(message);
    const response = result.response.text();

    console.log(`[${sessionId}] Response: "${response.substring(0, 100)}..."`);

    // Update chat history
    chatHistory.push(
      { role: "user", parts: [{ text: message }] },
      { role: "model", parts: [{ text: response }] }
    );
    
    // Keep only last 10 exchanges
    if (chatHistory.length > 20) {
      chatHistory = chatHistory.slice(-20);
    }
    
    chatSessions.set(sessionId, chatHistory);

    res.json({
      success: true,
      data: {
        message: response,
        language: language,
        sessionId: sessionId
      }
    });

  } catch (error) {
    console.error('Error in sendMessage:', error);
    
    let errorMessage = 'Failed to process message';
    if (error.message?.includes('API_KEY_INVALID')) {
      errorMessage = 'Invalid API key';
    } else if (error.message?.includes('quota')) {
      errorMessage = 'API quota exceeded';
    }
    
    res.status(500).json({
      success: false,
      error: errorMessage,
      details: error.message
    });
  }
};

const clearChat = async (req, res) => {
  try {
    const { sessionId = 'default' } = req.body;
    chatSessions.delete(sessionId);
    
    res.json({
      success: true,
      message: 'Chat history cleared'
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: 'Failed to clear chat'
    });
  }
};

module.exports = { sendMessage, clearChat };